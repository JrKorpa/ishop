<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-touch-fullscreen" content="yes"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="msapplication-tap-highlight" content="no"/>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1"/>
    <title>消息详情</title>
    <link rel="stylesheet" type="text/css" href="../css/base.css">
    <link rel="stylesheet" type="text/css" href="../css/nctouch_chat.css?v=6">
    <link rel="stylesheet" type="text/css" href="../css/fonts/iconfont.css">
    <link rel="stylesheet" href="../css/video.css?v=20170915">
</head>
<body>
<header id="header" class="fixed">
    <div class="header-wrap">
        <div class="header-l"><a href="javascript:history.go(-1)"> <i class="back"></i> </a></div>
        <div class="header-title">
            <h1>消息详情</h1>
        </div>
        <div class="header-r"><a href="javascript:void(0)" class="msg-log" id="chat_msg_log"><i></i>历史</a></div>
    </div>
</header>
<div class="nctouch-chat-layout" id="normal-chat-screen">
    <div class="nctouch-chat-con">
        <!--<div class="margin-heigh"></div>-->
        <div id='wrapper'>
            <div id='scroller'>
                <div id="pullDown" class="hide">
                    <span class="pullDownIcon"></span><span class="pullDownLabel">下拉刷新...</span>
                </div>
                <div id="chat_msg_html"></div>
            </div>
        </div>
        <a href="javascript:void(0);" id="anchor-bottom"></a>
    </div>
    <div class="nctouch-chat-bottom">
        <div id="normal-chat-bottom">
            <div class="chat-input-layout"><span class="open-audio icon icon-maikefeng" style="display:none;"><a
                    href="#"></a></span>
                <div class="input-box">
                    <input type="text" id="msg"/>
                    <input type="button" id="record" class="open_record" data-flag='0' value="按住 说话">
                    <a href="#" id="open_smile" class="open-smile icon icon-xiaolian"></a>
                    <a href="#" id="open_more" class="open-more icon icon-jiahao"></a>
                    <a href="javascript:void(0)" id="submit" class="submit sendmessage hide"></a></div>
            </div>
            <div class="chat-smile-layout hide" id="chat_smile">
                <ul>
                </ul>
            </div>
            <div class="open-more-layout hide" id="more_plus">
                <ul>
                    <li>
                        <div id='open_image_picker'><i class="icon icon-zhaopian"></i> <span>照片</span></div>
                        <input type="file" hidefocus="true" size="1" accept="image/*" class="input-file" name="file"
                               id="img-file" style="display: none;"/>
                    </li>
                    <li>
                        <div id='open_video_capture'><i class="icon icon-shipin"></i> <span>视频</span></div>
                    </li>
                    <!-- <li>
                        <div id='open_video_chat'><i class="icon icon-shipin"></i> <span>视话</span></div>
                    </li> -->
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="video-chat-panel" id="video-chat-screen">
    <!--
     * Keep the HTML id attributes in sync with |UI_CONSTANTS| defined in
     * appcontroller.js.
    -->
    <div id="videos">
        <video id="mini-video" autoplay muted></video>
        <video id="remote-video" autoplay></video>
        <video id="local-video" autoplay muted></video>
    </div>
    <div id="icons" class="hidden">
        <svg id="mute-audio" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewbox="-10 -10 68 68">
            <title>title</title>
            <circle cx="24" cy="24" r="34">
                <title>Mute audio</title>
            </circle>
            <path class="on" transform="scale(0.6), translate(17,18)"
                  d="M38 22h-3.4c0 1.49-.31 2.87-.87 4.1l2.46 2.46C37.33 26.61 38 24.38 38 22zm-8.03.33c0-.11.03-.22.03-.33V10c0-3.32-2.69-6-6-6s-6 2.68-6 6v.37l11.97 11.96zM8.55 6L6 8.55l12.02 12.02v1.44c0 3.31 2.67 6 5.98 6 .45 0 .88-.06 1.3-.15l3.32 3.32c-1.43.66-3 1.03-4.62 1.03-5.52 0-10.6-4.2-10.6-10.2H10c0 6.83 5.44 12.47 12 13.44V42h4v-6.56c1.81-.27 3.53-.9 5.08-1.81L39.45 42 42 39.46 8.55 6z"
                  fill="white"/>
            <path class="off" transform="scale(0.6), translate(17,18)"
                  d="M24 28c3.31 0 5.98-2.69 5.98-6L30 10c0-3.32-2.68-6-6-6-3.31 0-6 2.68-6 6v12c0 3.31 2.69 6 6 6zm10.6-6c0 6-5.07 10.2-10.6 10.2-5.52 0-10.6-4.2-10.6-10.2H10c0 6.83 5.44 12.47 12 13.44V42h4v-6.56c6.56-.97 12-6.61 12-13.44h-3.4z"
                  fill="white"/>
        </svg>

        <svg id="mute-video" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewbox="-10 -10 68 68">
            <circle cx="24" cy="24" r="34">
                <title>Mute video</title>
            </circle>
            <path class="on" transform="scale(0.6), translate(17,16)"
                  d="M40 8H15.64l8 8H28v4.36l1.13 1.13L36 16v12.36l7.97 7.97L44 36V12c0-2.21-1.79-4-4-4zM4.55 2L2 4.55l4.01 4.01C4.81 9.24 4 10.52 4 12v24c0 2.21 1.79 4 4 4h29.45l4 4L44 41.46 4.55 2zM12 16h1.45L28 30.55V32H12V16z"
                  fill="white"/>
            <path class="off" transform="scale(0.6), translate(17,16)"
                  d="M40 8H8c-2.21 0-4 1.79-4 4v24c0 2.21 1.79 4 4 4h32c2.21 0 4-1.79 4-4V12c0-2.21-1.79-4-4-4zm-4 24l-8-6.4V32H12V16h16v6.4l8-6.4v16z"
                  fill="white"/>
        </svg>

        <!--<svg id="fullscreen" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewbox="-10 -10 68 68">
          <circle cx="24" cy="24" r="34">
            <title>Enter fullscreen</title>
          </circle>
          <path class="on" transform="scale(0.8), translate(7,6)" d="M10 32h6v6h4V28H10v4zm6-16h-6v4h10V10h-4v6zm12 22h4v-6h6v-4H28v10zm4-22v-6h-4v10h10v-4h-6z" fill="white"/>
          <path class="off" transform="scale(0.8), translate(7,6)"  d="M14 28h-4v10h10v-4h-6v-6zm-4-8h4v-6h6v-4H10v10zm24 14h-6v4h10V28h-4v6zm-6-24v4h6v6h4V10H28z" fill="white"/>
        </svg>-->

        <svg id="hangup" class="" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewbox="-10 -10 68 68">
            <circle cx="24" cy="24" r="34">
                <title>Hangup</title>
            </circle>
            <path transform="scale(0.7), translate(11,10)"
                  d="M24 18c-3.21 0-6.3.5-9.2 1.44v6.21c0 .79-.46 1.47-1.12 1.8-1.95.98-3.74 2.23-5.33 3.7-.36.35-.85.57-1.4.57-.55 0-1.05-.22-1.41-.59L.59 26.18c-.37-.37-.59-.87-.59-1.42 0-.55.22-1.05.59-1.42C6.68 17.55 14.93 14 24 14s17.32 3.55 23.41 9.34c.37.36.59.87.59 1.42 0 .55-.22 1.05-.59 1.41l-4.95 4.95c-.36.36-.86.59-1.41.59-.54 0-1.04-.22-1.4-.57-1.59-1.47-3.38-2.72-5.33-3.7-.66-.33-1.12-1.01-1.12-1.8v-6.21C30.3 18.5 27.21 18 24 18z"
                  fill="white"/>
        </svg>

    </div>

</div>
<div class="propo_masker hide"></div>
<script type="text/javascript" src="../js/zepto.min.js"></script>
<script type="text/javascript" src="../js/config.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<script type="text/javascript" src="../js/simple-plugin.js"></script>
<script type="text/javascript" src="../js/iscroll-plugin.js"></script>
<!-- <script type="text/javascript" src="../js/video-chat/pizzicato.min.js"></script> -->
<!--原来是在chat_info.js里面动态加载的-->
<script type="text/javascript" src="../js/socket.io.js"></script>
<script type="text/javascript" src="../js/chat.js?v=1.1"></script>
<script type="text/javascript" src="../cordovalib/cordova.js"></script>
<script type="text/javascript" src="../js/cordova/chat.js"></script>
<script type="text/javascript" src="../js/adapter.js"></script>
<!-- <script type="text/javascript" src="../js/video-chat.js?1.1"></script> -->
<script type="text/javascript" src="../js/layer/layer.js"></script>
<script type="text/javascript">
    //如果是在iframe中，隐藏头部导航
    if (window.frames.length != parent.frames.length) {
        $(document).find("#header").hide();
    }
    setTimeout(function () {
        if (window.WebViewJavascriptBridge) {
            var startTime;
            var lazyRecordTimer;

            window.call_native("require_permission", {'type':'record'});

            function send_IM_msg(upload_resp, mine_type) {
                if (typeof current_socket == 'undefined') {
                    $.sDialog({
                        skin: "red",
                        content: '会话通信失败',
                        okBtn: false,
                        cancelBtn: false
                    });
                    return;
                }
                var data = {
                    key: key,
                    t_id: t_id,
                    t_name: to_memberInfo.member_name,
                    t_msg: upload_resp['1']['file'],
                    chat_goods_id: chat_goods_id,
                    msg_type: mine_type
                };
                $.ajax({
                    type: 'post',
                    url: ApiUrl + '/index.php?act=member_chat&op=send_msg',
                    data: data,
                    dataType: 'json',
                    success: function (result) {
                        if (result.code == 200) {
                            var msgData = result.datas.msg;
                            current_socket.emit('send_msg', msgData);
                        } else {
                            $.sDialog({
                                skin: "red",
                                content: result.datas.error,
                                okBtn: false,
                                cancelBtn: false
                            });
                            return false;
                        }
                    }
                });
            };

            function add_to_chat_box(date, content) {
                var id = date.getTime();
                var msgtime = date.Format("yyyy-MM-dd HH:mm:ss");
                $("#chat_msg_html").append('<dl class="msg-time">' + msgtime + '</dl><dl class="msg-me" id="div_' + id + '"><dt><img src="/data/upload/shop/common/default_user_portrait.gif" alt=""/><i></i></dt><dd>' + content + '<div class="container"><div class="bar" style="width:0%;" data-percent="1"></div></div></dd></dl>');
                $("#anchor-bottom")[0].scrollIntoView();
            };

            $('#record').on('touchstart', function (e) {
                e.preventDefault();
                startTime = new Date().getTime();
                lazyRecordTimer = setTimeout(function () {
                    window.call_native('startRecord', {'ts': 30.0});
                }, 300);
            });

            $('#record').on('touchend', function (e) {
                e.preventDefault();
                if (new Date().getTime() - startTime < 300) {
                    startTime = 0;
                    clearTimeout(lazyRecordTimer);
                }
                // ensure stop
                window.call_native('stopRecord', {'call': 'stop'});
            });

            WebViewJavascriptBridge.registerHandler('record_cb', function (resp, callback) {
                var json = JSON.parse(resp);
                if (json) {
                    switch (json.code) {
                        case 1:
                            // show recording style
                            $('#record').addClass('hold');
                            break;
                        case 2:
                            // hide recording style
                            $('#record').removeClass('hold');
                            break;
                        case 100:
                            $('#record').removeClass('hold');
                            if (json.resp.state == 1) {
                                var fileUrl = json.resp.data['1']['file'];
                                var html = '<div class="audio"><div onclick="play_sound(this);" class="Play"><span class="icon icon-play"></span></div><div class="Process"> <div class="ProcessAll"></div><div class="ProcessNow"></div><div class="SongTime">00:00&nbsp;|&nbsp;00:00</div> </div><audio controls="controls" src="' + fileUrl + '">wav</audio></div>';

                                add_to_chat_box(new Date(), html);
                                send_IM_msg(json.resp.data, "audio/wav");
                            } else {
                                $.sDialog({
                                    skin: "red",
                                    content: json.resp.msg,
                                    okBtn: false,
                                    cancelBtn: false
                                });
                            }
                            break;
                        case 99:
                            $('#record').removeClass('hold');
                            $.sDialog({
                                skin: "red",
                                content: '上传失败',
                                okBtn: false,
                                cancelBtn: false
                            });
                            break;
                    }
                }
            });

            $('#open_video_capture').on('touchstart', function (e) {
                e.preventDefault();
                window.call_native('startLiteVideo', {'ts': 10.0});
            });

            WebViewJavascriptBridge.registerHandler('litevideo_cb', function (resp, callback) {
                var json = JSON.parse(resp);
                if (json) {
                    switch (json.code) {
                        case 1:
                        case 2:
                            break;
                        case 100:
                            if (json.resp.state == 1) {
                                var fileUrl = json.resp.data['1']['file'];
                                var html = '<video controls="controls"><source src="' + fileUrl + '" type="video/mp4"></video>';

                                add_to_chat_box(new Date(), html);
                                send_IM_msg(json.resp.data, "video/mp4");
                            } else {
                                $.sDialog({
                                    skin: "red",
                                    content: json.resp.msg,
                                    okBtn: false,
                                    cancelBtn: false
                                });
                            }
                            break;
                        case 99:
                            $.sDialog({
                                skin: "red",
                                content: '上传失败',
                                okBtn: false,
                                cancelBtn: false
                            });
                            break;
                    }
                }
            });
        }
    }, 300);
</script>
</body>
</html>